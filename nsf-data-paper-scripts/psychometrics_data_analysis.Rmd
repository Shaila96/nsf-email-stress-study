---
title: "Psychometrics Data Analysis"
# output: pdf_document 
# fontsize: 44pt
header-includes:
- \usepackage{booktabs}
- \usepackage{sectsty} \sectionfont{\centering}
output:
  pdf_document: default
  html_document: default
geometry: top=3.5cm, bottom=3cm
---


```{r echo = FALSE, warning = FALSE, message = FALSE} 

#-------------------------#
#--------LIBRARIES--------#
#-------------------------#
library(readr)
library(dplyr)
library(tidyverse)
library(ggplot2)
library(grid)
library(gridExtra)
library(ggpubr) 
library(directlabels)


#-------------------------#
#-----GLOBAL VARIABLES----#
#-------------------------#
project_dir <- "T:/Google Drive/University of Houston/CS - UH/@Research - CPL/@Projects/NsfStressDataCuration/nsf-data-paper-scripts"
setwd(project_dir)

data_dir <- 'data'
survey_data_dir <- 'survey-data'
plots_dir <- 'plots'

data_file_name <- 'result_df.csv'

pre_survey_file_name <- 'pre-survey.csv'
post_survey_file_name <- 'post-survey.csv'
good_subj_file_name <- 'subj_good_df.csv'

good_subj_list <- tibble()
pre_survey_df <- tibble()
post_survey_df <- tibble()
nasa_tlx_freq_df <- tibble()

na_val <- 'NA'

nasa_tlx_ques_list <- c("Nasa_Mental", "Nasa_Physical", "Nasa_Temporal",
                        "Nasa_Performance", "Nasa_Effort", "Nasa_Frustration") 
nasa_task_options <- c("Strongly disagree", "Disagree", "Somewhat disagree", 
                       "Neither agree or disagree", "Somewhat agree", "Agree", "Strongly agree")



#-------------------------#
#---FUNCTION DEFINITION---#
#-------------------------#
convert_to_csv <- function(df, file_name) {
  write.table(df, file = file.path(data_dir, file_name), row.names=F, sep = ',')
}

get_significance_sign <- function(p_value) { 
  if (p_value > 0.05) { 
    return(" ") 
  } else if (p_value <= 0.001) { 
    return("***") 
  } else if (p_value <= 0.01) { 
    return("**") 
  } else if (p_value <= 0.05) { 
    return("*") 
  } 
} 

print_msg <- function(msg) {
  # cat(msg)
  print(msg)
  message(msg)
}

print_significance <- function(prop_test, alternative_val) {
  p_val <- prop_test$p.value
  if (p_val < 0.05) {
    print_msg(paste0(get_significance_sign(p_val), ' The proportion of agreement is significantly ', alternative_val))
  } else {
    print_msg(paste0('The proportion of agreement is NOT significantly ', alternative_val))
  }
  print_msg(paste0('than the proportion of disagreement, with a p-value = ', p_val))
}

is_match <- function(string_we_have, pattern_we_are_looking_for) { 
  return(grepl(pattern_we_are_looking_for, string_we_have)) 
} 

replace_dot_space <- function(str) {
  gsub("\\.", "-", str)
}

save_plot <- function(plot_name, plot, default_width=15, default_height=10) {
  plot_path <- file.path(project_dir, plots_dir, paste0(plot_name, '.png'))
  ggsave(plot_path, plot, width=default_width, height=default_height)
  
  plot_path <- file.path(project_dir, plots_dir, paste0(plot_name, '.pdf'))
  ggsave(plot_path, plot, device=cairo_pdf, width=default_width, height=default_height)
}


# extract_Nasa_score <- function() {
#   #---- NOTE: YOU HAVE TO CALCULATE ALL SCALES FOR ONE SUBJECT, THEN GO FOR NEXT RWOW/SUBJECT ----#
#   
#   pre_scale_df <- pre_survey_df[, c(22, seq(33, 42))]
#   post_scale_df <- post_survey_df[, c(22, seq(30, 39))]
#   
#   colnames(pre_scale_df) <- c("SubjectID",
#                            "Nasa_Q1", "Nasa_Q2", "Nasa_Q3", "Nasa_Q4", "Nasa_Q5",
#                            "Nasa_Q6", "Nasa_Q7", "Nasa_Q8", "Nasa_Q9", "Nasa_Q10")
#   
#   colnames(post_scale_df) <- c("SubjectID",
#                               "ERQ_Q1", "ERQ_Q2", "ERQ_Q3", "ERQ_Q4", "ERQ_Q5",
#                               "ERQ_Q6", "ERQ_Q7", "ERQ_Q8", "ERQ_Q9", "ERQ_Q10")
#   
#   scale_df <- merge(pre_scale_df, post_scale_df, by="SubjectID", all=T)
#   convert_to_csv(scale_df, file.path(data_path, '@pre-post-survey-data.csv'))
#   
#   apply(scale_df, 1, function(each_row) extract_scale_score_each_row(each_row))
# 
#   # print(head(scale_score_df, 2))
#   # print(tail(scale_score_df, 2))
# 
#   
#   
#   ################################################
#   ##          REMOVE NA ScaleValue ROWS         ##
#   ################################################
#   convert_to_csv(scale_score_df, file.path(db_data_path, 'rank_data_scale.csv'))
# }


read_data <- function() {
  pre_survey_df <<- read_csv(file.path(data_dir, survey_data_dir, pre_survey_file_name))
  post_survey_df <<- read_csv(file.path(data_dir, survey_data_dir, post_survey_file_name))
  good_subj_list <<- read_csv(file.path(data_dir, good_subj_file_name))
}

extract_nasa_tlx_score <- function() {
  nasa_tlx_df <<- post_survey_df[, c(22, seq(24, 29))]
  
  ## print_msg(colnames(nasa_tlx_df)) ## DO NOT DELETE
  colnames(nasa_tlx_df) <<- c("SubjectID", nasa_tlx_ques_list)
  ## print_msg(colnames(nasa_tlx_df)) ## DO NOT DELETE
  
  ## Filter out the data for good subject list only 
  nasa_tlx_df <<- nasa_tlx_df %>% 
    filter(SubjectID %in% good_subj_list$Subject)
  ## convert_to_csv(nasa_tlx_df, file.path(survey_data_dir, 'nasa_tlx_score.csv'))
}


draw_group_bar_chart_nasa_tlx <- function() {
  ## getting the answer frequency for each question
  nasa_tlx_freq_df <<- nasa_tlx_df %>%
    gather(Question, Answer, -SubjectID) %>% ## making the data wide to long for all signals
    select(-SubjectID) %>%                   ## We do not need the subject id
    group_by(Question, Answer) %>%
    summarize(Frequency=n())
  
  nasa_tlx_freq_df$Question <<- factor(nasa_tlx_freq_df$Question, levels=nasa_tlx_ques_list)  
  ## convert_to_csv(nasa_tlx_freq_df, file.path(survey_data_dir, 'nasa_tlx_for_plot.csv'))
  
  plot <- nasa_tlx_freq_df %>% 
    ggplot(aes(x=Answer, y=Frequency, fill=Question)) + 
    geom_bar(position="dodge", stat="identity") +
    scale_x_discrete(limits = nasa_task_options) +
    theme_bw() + 
    theme(text = element_text(size = 16),
          axis.title = element_text(size = 16),
          axis.text.x = element_text(size = 8, angle = 45, hjust = 1),
          plot.title = element_text(hjust = 0.5, size = 20, face = "bold")) 
  
  print(plot)
  
  plot <- plot + 
    theme(text = element_text(size = 20),
          axis.title = element_text(size = 20),
          axis.text.x = element_text(size = 16, angle = 45, hjust = 1)) 
  save_plot('nasa-frequency', plot, 18)
}

get_bar_plot_df <- function(df) {
  df <- df %>%
    gather(Frequency, Value, -Question)
  return(df)
}

generate_bar_plot <- function(df, title) {
  plot <- get_bar_plot_df(df) %>%
    ggplot(aes(x=Frequency, y=Value)) +
    geom_bar(stat="identity") +
    ggtitle(title)
  print(plot)
}

generate_prop_test <- function(df, nasa_ques, comparison_option, alternative_val) {
  total_response <- nrow(nasa_tlx_df)
  
  agree_df <- df %>%
    filter(Answer > comparison_option) %>% 
    summarize(agree_freq = sum(Frequency))
    
  disagree_df <- df %>% 
    filter(Answer <= comparison_option) %>% 
    summarize(disagree_freq = sum(Frequency))
  
  freq_df <- merge(agree_df, disagree_df, by='Question')
  # print_msg(str(freq_df))
  
  generate_bar_plot(freq_df, nasa_ques)
    
  print_msg(paste0(nasa_ques, ":"))
  print_msg(paste0('Agree: ', freq_df$agree_freq))
  print_msg(paste0('Disagree: ', freq_df$disagree_freq))
  
  prop_test <- prop.test(c(freq_df$agree_freq, freq_df$disagree_freq),
            c(total_response, total_response),
            p = NULL,
            alternative = alternative_val,
            correct = T)
  print_msg(prop_test)
  print_significance(prop_test, alternative_val)
}


get_proportion_test_nasa_tlx <- function() {
  for (nasa_ques in nasa_tlx_ques_list) {
    temp_nasa_tlx_freq_df <- nasa_tlx_freq_df[nasa_tlx_freq_df$Question==nasa_ques, ]
    
    generate_prop_test(temp_nasa_tlx_freq_df, nasa_ques, 4, 'greater')
    if (nasa_ques=='Nasa_Performance') {
      generate_prop_test(temp_nasa_tlx_freq_df, nasa_ques, 3, 'less')
    }
  }
}
``` 



```{r echo=FALSE, warning = FALSE, message = FALSE}
# extract_Nasa_score()
read_data()
extract_nasa_tlx_score()
draw_group_bar_chart_nasa_tlx()
```

\newpage
```{r echo=FALSE, warning = FALSE, message = FALSE}
get_proportion_test_nasa_tlx()
```
